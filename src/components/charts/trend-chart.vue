<template>
  <div style="width:100%;height:100%;" ref="chart">
  </div>
</template>

<script>
import {
  calculateMaxIntegerValue,
  calculateMinIntegerValue,
  MaxArrValueTime,
  MinArrValueTime,
  MaxArrValue,
  MinArrValue,
  numberUnitProcess
} from "@/utils/utils";
import {
  datetimeFormatSeconds
} from '@/utils/date';

export default {
  props: {
    chartData: {
      type: Array,
      default: function () {
        return [];
      }
    },
    legend: {
      type: Array,
      default: function () {
        return [];
      }
    },
    dataX: {
      type: Array,
      default: function () {
        return [];
      }
    },
    startTime: {
      type: Number,
      default: null
    },
    endTime: {
      type: Number,
      default: null
    },
    // amendStartTime:{
    //     type: Number,
    //     default: null
    // },
    // amendEndTime:{
    //     type: Number,
    //     default: null
    // }
  },
  data() {
    return {
      chart: null,
      chartInfo: [],
      // option:{"color":["#3CB371","#B0C4DE","orange"],"tooltip":{"show":false,"trigger":"axis"},"legend":{"show":false,"data":["指标1","指标2"]},"grid":{"left":10,"right":20,"bottom":3,"top":3},"xAxis":{"type":"category","boundaryGap":false,"data":["11:10","11:11","11:12","11:13","11:14","11:15","11:16","11:17","11:18","11:19","11:20","11:21","11:22","11:23","11:24","11:25","11:26","11:27","11:28","11:29","11:30","11:31","11:32","11:33","11:34","11:35","11:36","11:37","11:38","11:39","11:40","11:41","11:42","11:43","11:44","11:45","11:46","11:47","11:48","11:49","11:50","11:51","11:52","11:53","11:54","11:55","11:56","11:57","11:58","11:59","12:00","12:01","12:02","12:03","12:04","12:05","12:06","12:07","12:08","12:09","12:10","12:11","12:12","12:13","12:14","12:15","12:16","12:17","12:18","12:19","12:20","12:21","12:22","12:23","12:24","12:25","12:26","12:27","12:28","12:29","12:30","12:31","12:32","12:33","12:34","12:35","12:36","12:37","12:38","12:39","12:40","12:41","12:42","12:43","12:44","12:45","12:46","12:47","12:48","12:49","12:50","12:51","12:52","12:53","12:54","12:55","12:56","12:57","12:58","12:59","13:00","13:01","13:02","13:03","13:04","13:05","13:06","13:07","13:08","13:09","13:10","13:11","13:12","13:13","13:14","13:15","13:16","13:17","13:18","13:19","13:20","13:21","13:22","13:23","13:24","13:25","13:26","13:27","13:28","13:29","13:30","13:31","13:32","13:33","13:34","13:35","13:36","13:37","13:38","13:39","13:40","13:41","13:42","13:43","13:44","13:45","13:46","13:47","13:48","13:49","13:50","13:51","13:52","13:53","13:54","13:55","13:56","13:57","13:58","13:59","14:00","14:01","14:02","14:03","14:04","14:05","14:06","14:07","14:08","14:09","14:10","14:11","14:12","14:13","14:14","14:15","14:16","14:17","14:18","14:19","14:20","14:21","14:22","14:23","14:24","14:25","14:26","14:27","14:28","14:29","14:30","14:31","14:32","14:33","14:34","14:35","14:36","14:37","14:38","14:39","14:40","14:41","14:42","14:43","14:44","14:45","14:46","14:47","14:48","14:49","14:50","14:51","14:52","14:53","14:54","14:55","14:56","14:57","14:58","14:59","15:00","15:01","15:02","15:03","15:04","15:05","15:06","15:07","15:08","15:09","15:10","15:11","15:12","15:13","15:14","15:15","15:16","15:17","15:18","15:19","15:20","15:21","15:22","15:23","15:24","15:25","15:26","15:27","15:28","15:29","15:30","15:31","15:32","15:33","15:34","15:35","15:36","15:37","15:38","15:39","15:40","15:41","15:42","15:43","15:44","15:45","15:46","15:47","15:48","15:49","15:50","15:51","15:52","15:53","15:54","15:55","15:56","15:57","15:58","15:59","16:00","16:01","16:02","16:03","16:04","16:05","16:06","16:07","16:08","16:09","16:10","16:11","16:12","16:13","16:14","16:15","16:16","16:17","16:18","16:19","16:20","16:21","16:22","16:23","16:24","16:25","16:26","16:27","16:28","16:29","16:30","16:31","16:32","16:33","16:34","16:35","16:36","16:37","16:38","16:39","16:40","16:41","16:42","16:43","16:44","16:45","16:46","16:47","16:48","16:49","16:50","16:51","16:52","16:53","16:54","16:55","16:56","16:57","16:58","16:59","17:00","17:01","17:02","17:03","17:04","17:05","17:06","17:07","17:08","17:09","17:10"],"axisTick":{"show":false},"axisLine":{"show":false},"axisLabel":{"show":false}},"yAxis":{"type":"value","axisTick":{"show":false},"axisLine":{"show":false},"splitLine":{"show":false},"axisLabel":{"show":false,"textStyle":{"color":"#888"}},"max":43000,"min":36000},"series":[{"cursor":"pointer","name":"当天","type":"line","symbol":"none","smooth":true,"data":[40872,41303,41643,40988,41214,41169,41328,41166,41575,41282,41026,41293,40783,41280,41155,41459,41309,40855,41312,40782,41355,41672,41600,41278,40728,40768,41102,41285,40986,40740,40857,40509,40575,40671,41365,40726,40771,40655,40687,41275,40702,41016,40538,40976,40826,40619,40833,41374,40536,40677,41044,41356,40819,41092,40782,41071,40713,40906,40147,40099,40587,40301,40452,40861,41152,40441,40122,40752,40510,40835,40471,40729,41112,41264,40783,41268,41006,41065,41255,41026,40963,41313,41060,41600,40999,41154,41509,41469,41315,41601,41559,42030,40915,41678,41913,41542,41452,41834,41722,41502,41712,41446,41436,41600,41652,41688,41352,41572,42164,41888,41730,41692,42015,41509,41666,41181,41737,41440,41458,41619,41880,42086,41625,41312,41945,42303,41835,41776,41649,41409,41270,41224,41571,41338,41491,41277,40787,40796,40785,41005,41187,41158,40459,40703,41257,40648,41082,40552,40291,40197,40173,40322,40251,40193,40165,40561,39950,40168,40013,40217,39917,39743,39899,39969,40312,39926,39939,39696,39884,39928,40143,40204,39829,39990,40482,39714,39696,39722,39826,39493,39532,39659,39593,39739,39733,39549,39255,39219,39426,39548,39140,39287,39167,39428,39942,39376,39478,39595,39845,39164,39650,39588,39209,38793,39272,39496,39740,40262,40470,40279,40324,40671,40396,40465,40120,40530,40595,40250,39680,40247,40015,39983,39797,40173,40230,40431,39971,39634,40425,41028,40598,40271,40125,40499,40091,40041,40302,40587,40262,40923,40731,40410,40264,40306,40620,40686,40724,40226,40436,40393,40353,40183,40321,39838,40105,40471,40350,40111,40377,40520,40367,40308,40686,40924,40013,39960,40841,40969,40621,40180,40630,40933,40320,39533,39509,39186,39748,39584,39188,39515,39137,39859,39625,39333,39659,39583,39135,39413,39956,39580,39591,39961,39850,39878,39442,39205,39749,39282,39648,39742,39890,39704,39542,40131,40130,39937,39933,40396,39659,40374,39765,40437,39936,40213,40584,40078,40312,40375,41020,40665,40418,40691,40126,40022,40446,40135,40116,40461,40299,41225,40699,40341,40587,39976,40104,40807,41100,40855,40355,40291,40860,40999,41011,40500,40368,41255,41155,40512,40788,41310,41532,41438,41426,41373,41612,41412,41374,41970,41295,41386,41505]},{"cursor":"pointer","name":"1天前","type":"line","symbol":"none","smooth":true,"data":[39106,39246,38918,39233,38972,39304,39407,39051,39471,38803,38732,39634,39431,38933,38691,39556,38577,39161,39198,39291,39198,39205,39139,39138,38964,38779,38368,39010,39067,38629,38555,39262,38982,39176,38803,38805,38585,39195,38688,38739,38430,39489,39070,38774,38227,38664,38958,38748,38655,38679,39044,39918,39120,38566,38635,38827,38973,38319,38608,38790,38788,38587,39048,39133,38962,38702,38862,38963,38449,38454,39179,38962,38617,38840,39436,39783,39171,39326,39590,39473,39851,40401,39186,39135,40056,40276,39727,39302,39110,39401,39494,39509,39340,40065,39761,39932,39337,40089,39625,39655,39482,40422,39705,39567,39514,39805,39696,39294,39734,39479,39720,39828,40272,39331,39005,39357,39644,39829,39627,38910,39318,39356,38898,39091,39561,39737,39493,39371,39123,39131,39343,39152,39149,39093,38946,39274,39465,38487,38839,38345,38558,39123,39009,38150,38145,37956,38228,38354,38382,38600,38076,38266,38032,38413,37755,38376,38099,37687,38028,38287,37988,38181,37727,37929,38043,37874,37792,38215,38200,37538,37919,38152,37794,37360,37910,38120,37354,36945,37251,37948,37556,37363,37422,37426,37839,37812,37206,36981,37835,37509,36838,37710,37294,37077,37389,37273,37399,37212,37987,37520,37383,37130,37019,37757,37291,37037,38275,38469,38351,38581,38422,38216,38184,38922,38842,38292,38195,38084,38408,38423,38428,38084,38707,38766,38487,38269,38438,38595,38723,38199,38424,38804,38070,38656,39079,38425,38543,38541,38518,38632,39017,39010,38855,38626,38687,39120,39006,38923,38414,38892,38791,38821,38765,38837,38528,38817,39136,38856,38462,39264,38748,38602,38546,39016,39038,38720,39387,38725,38783,38507,37765,37888,38017,37422,37931,37753,38041,38681,37994,38135,37854,38078,38116,38143,38000,38241,38191,37841,38470,38498,38129,38567,38938,38323,37810,38237,38753,38284,38108,38598,38702,38634,38439,39196,38551,38622,39270,38832,38868,38703,39070,38866,38536,38769,39570,39422,38655,38775,39011,39119,38670,39013,39254,39071,39054,39056,38937,39188,38945,38860,39368,39140,39159,39254,39332,39048,39210,38928,38704,39010,39415,39635,39204,39383,39379,39742,39768,39367,39605,39195,39668,39868,39698,39923,40074,39692,39304,39864,40644,39849,39919]}]},
    }
  },
  watch: {
    chartData: {
      immediate: true,
      handler(chartData) {
        this.chartInfo = chartData;
      },
    },
    option: {
      immediate: true,
      handler(option) {
        this.$nextTick(() => {
          if (_.isArray(this.chartInfo) && this.chartInfo.length > 0) {
            // 渲染图表
            try {
              this.chart.setOption(option);
            } catch (e) {
              this.initChart();
            }
          }
        });
      }
    },
  },
  computed: {
    option() {
      let maxArr = [];
      let minArr = [];
      let series = [];
      this.chartInfo.forEach(item => {
        maxArr.push(MaxArrValueTime(item.data));
        minArr.push(MinArrValueTime(item.data));
        series.push({
          cursor: 'pointer',
          name: item.name,
          type: 'line',
          symbol: 'none',
          smooth: true,
          data: item.data,
          lineStyle: {
            width: 1,
            // type: lineStyle[0],
          },
          markArea: {
            itemStyle: {
              color: 'rgba(255, 173, 177, 0.4)'
            },
            data: [
              [
                {
                  xAxis: datetimeFormatSeconds(new Date(this.startTime * 1000))
                },
                {
                  xAxis: datetimeFormatSeconds(new Date(this.endTime * 1000))
                },
              ],
            ]
          }
        },)
      });

      let max = MaxArrValue(maxArr);
      let min = MinArrValue(minArr);

      return {
        color: ['FireBrick', '#3CB371', '#B0C4DE', 'orange'],
        tooltip: {
          show: true,
          trigger: 'axis'
        },
        legend: {
          show: true,
          data: this.legend,
          textStyle: {
            fontSize: 12,
          },
        },
        grid: {
          left: 50,
          right: 20,
          bottom: 20,
          top: 20,
        },
        xAxis: {
          type: 'time',
          boundaryGap: false,
          data: this.dataX,
          minInterval: 1800 * 1000,
          splitNumber: 10,
          axisTick: {
            show: false //去除刻度线
          },
          axisLine: {
            show: false //去除轴线
          },
          splitLine:{
            show: false //去掉网格线
          },
          axisLabel: {
            textStyle: {
              color: '#888',
              fontSize: 12,
            },
            // formatter: (value) => {
            //     return value.split(' ')[1].substring(0, 5);
            // },
          },
        },
        yAxis: {
          type: 'value',
          axisTick: {
            show: false //去除刻度线
          },
          axisLine: {
            show: false //去除轴线
          },
          axisLabel: {
            textStyle: {
              color: '#888',
              fontSize: 12,
            },
            formatter: (value) => {
              let data = numberUnitProcess(value, 2, true);
              return data.data + data.unit;
            },
          },
          max: _.isNil(max) ? null : calculateMaxIntegerValue(max),
          min: _.isNil(min) ? null : calculateMinIntegerValue(min),
        },
        // xAxis: {
        //     type: 'category',
        //     boundaryGap: false,
        //     data: this.dataX,
        //     axisTick: {
        //         show: false //去除刻度线
        //     },
        //     axisLine: {
        //         show: false //去除轴线
        //     },
        //     axisLabel: {
        //         show: false
        //     },
        // },
        // yAxis: {
        //     type: 'value',
        //     axisTick: {
        //         show: false //去除刻度线
        //     },
        //     axisLine: {
        //         show: false //去除轴线
        //     },
        //     splitLine: { //分割线
        //         show: false
        //     },
        //     axisLabel: {
        //         show: false,
        //         textStyle: {
        //             color: '#888',
        //         },
        //         formatter: (value) => {
        //             let data = numberUnitProcess(value, 2, true);
        //             return data.data + data.unit;
        //         },
        //     },
        //     max: _.isNil(max) ? null : calculateMaxIntegerValue(max),
        //     min: _.isNil(min) ? null : calculateMinIntegerValue(min),
        // },
        series: series
      }

    },
  },
  methods: {
    // 初始化图表
    initChart() {
      if (this.chart == null) {
        this.chart = echarts.init(this.$refs.chart);
        this.chart.resize();
        this.chart.setOption(this.option);
      } else {
        try {
          this.chart.dispose();
        } catch (e) {
          this.chart = null;
        } finally {
          this.chart = null;
          this.initChart();
        }
      }
    },
    chartResize() {
      setTimeout(() => {
        try {
          this.chart.resize();
        } catch (e) {
          this.chart = null;
          return;
        }
      }, 300);
    },
  },
  created() {
    //开发使用，之后删除
    setTimeout(() => {
      this.initChart();
    }, 300);
  },
  mounted() {
    window.addEventListener('resize', this.chartResize);
  },
  beforeDestroy() {
    if (this.chart != null) {
      this.chart.dispose();
    }
    window.removeEventListener('resize', this.chartResize);
  }
}
</script>